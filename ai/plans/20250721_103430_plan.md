# Execution Plan: Firestore Emulator Integration for Server-Only Testing (Updated)

Task: 17.4 Test Firestore Connection (with Emulator)
Created: 2025-07-21 10:34:30 UTC
Updated: 2025-07-21 10:41:18 UTC
Status: Pending

## Objective

- Directly verify that the Firestore service connects to the emulator and can read/write a document, using automated server-side tests only (no UI or browser-based tests).
- Ensure that Firestore security rules for the `games` collection are enforced as in production: reads should succeed, writes should fail for clients.
- Fetch and document the current Firestore security rules from the cloud for alignment and reference.

## Step-by-Step Plan

1. **Fetch Firestore Security Rules from Cloud**
   - Use the Google Cloud CLI (`gcloud`) to export the current Firestore security rules:
     - `gcloud firestore security-rules export ./firestore_rules_export`
   - Save and document the rules for reference and test alignment.
   - (If `gcloud` is not installed, document the need to install and authenticate it.)

2. **Test Infrastructure Setup**
   - Install required dev dependencies:
     - `jest`, `@testing-library/react`, `@testing-library/jest-dom`, `ts-jest`, `@types/jest`
     - (Playwright/browser E2E not needed, as all Firestore access is server-side)
   - Add or update npm scripts:
     - `test:unit` for Jest
     - `test:e2e` can be omitted for Firestore

3. **Write a Real Firestore Security Rules Test (Jest/Node)**
   - Write a test that:
     - Reads documents from the `games` collection (should succeed)
     - Attempts to write a document to the `games` collection (should fail with a permission error)
   - Assert that reads are allowed and writes are denied, matching the production rules.
   - Ensure the test uses the emulator and the latest rules.

4. **Log and Document**
   - Log all changes and test results in `/ai/CHANGELOG.md`.
   - Document any issues or mismatches between emulator and production rules.

---

**Note:**

- No UI or test page will be created.
- No Playwright/browser E2E test will be written for Firestore, as all access is server-side only.
