# Execution Plan: Firestore Emulator Integration for Testing

Task: 17.4 Test Firestore Connection (with Emulator)
Created: 2025-07-21 08:49:27 UTC
Status: Pending

## Objective

Enable all unit, integration, and E2E tests to run against a local Firestore emulator, enforcing security rules and protecting production data.

## Step-by-Step Plan

1. **Install and Configure the Emulator Suite**
   - Install Firebase CLI locally as a dev dependency: `npm install --save-dev firebase-tools`
   - Initialize emulator config: `npx firebase init emulators` (select Firestore)
   - Creates/updates `firebase.json` and `.firebaserc`

2. **Update Firestore Service to Support Emulator**
   - Modify `src/services/firebase.ts` to connect to emulator when `ENVIRONMENT="test"`:
     ```ts
     import { connectFirestoreEmulator } from 'firebase/firestore';
     if (process.env.ENVIRONMENT === 'test') {
       connectFirestoreEmulator(db, 'localhost', 8080);
     }
     ```
   - Add `ENVIRONMENT` to `.env.local.example`

3. **Test Setup Scripts**
   - Add npm scripts:
     ```json
     "scripts": {
       "emulators": "npx firebase emulators:start --only firestore",
       "test:unit": "jest",
       "test:e2e": "playwright test"
     }
     ```
   - (Optional) Use `wait-on` to ensure emulator is ready before running tests

4. **Write and Run Tests**
   - Unit/Integration (RTL): Use emulator, flush/reset data between tests
   - E2E (Playwright): App connects to emulator, test pages/routes can read/write test data

5. **Security Rule Validation**
   - All tests run with current Firestore security rules enforced
   - Iterate on rules locally, verify with tests before production

6. **Documentation and Logging**
   - Document emulator setup in `/ai/docs/testing-with-emulator.md` or `/tests/README.md`
   - Log all config and test changes in the CHANGELOG

## Checklist

- [ ] Install and configure Firebase Emulator Suite (locally)
- [ ] Update Firestore service to support emulator connection
- [ ] Add environment variable and update `.env.local.example`
- [ ] Add npm scripts for emulator/test runs
- [ ] Write and run tests using the emulator
- [ ] Document the workflow and log all changes
